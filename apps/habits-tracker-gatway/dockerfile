# Stage 1: Install dependencies
FROM node:18 AS builder
WORKDIR /usr/src/app

# Copy lockfile and main configs first
COPY pnpm-lock.yaml package.json tsconfig.json ./

# Install PNPM globally
RUN npm install -g pnpm

# Fix the PNPM symlink issue
RUN pnpm config set node-linker=hoisted

# Install all dependencies
RUN pnpm install

# Copy everything in the monorepo
COPY . .

# Install only for the gateway service
RUN pnpm install --filter=habits-tracker-gateway

# Build the service
RUN pnpm run --filter=habits-tracker-gateway build

# Stage 2: Create the final image
FROM node:18
WORKDIR /usr/src/app

# Copy built files from the builder stage
COPY --from=builder /usr/src/app .

# Expose the port
EXPOSE 5000

# Environment variables
ENV NODE_ENV=production
ENV CONSUL_HOST=consul
ENV CONSUL_PORT=8500
ENV SERVICE_NAME=gateway-service
ENV PORT=5000
ENV SERVICE_ADDRESS=gateway-service
ENV FRONTEND_URL=http://localhost:3000

# Run the service
CMD ["pnpm", "run", "start:dev"]